<div id="{$id}" class="row">
    <form action="{$action}" method="{$method|default='POST'}"
        enctype="multipart/form-data"
        class="{$class} {$attr|raw}">

        {volist name="rows" id="row"}
        {if condition="$row instanceof tpext\builder\common\Tab"}
        <div class="col-md-12">
            {:$row->render()}
        </div>
        {elseif condition="$row instanceof tpext\builder\form\step"}
        <div class="col-md-12">
            {:$row->render()}
        </div>
        {else/}
        <div class="form-group col-md-{$row->getColSize()} {$row->getClass()}
            {$row->getErrorClass()}"{$row->getAttr()|raw}>
            {:$row->render()}
        </div>
        {/if}
        {/volist}
    </form>

    <script>
        var ajax = {$ajax};
        var search = '{$search}';
        var lastsearch = '';
    
        function formSubmit()
        {
            lightyear.loading('hide');
            
            if(ajax)
            {
                lightyear.loading('show');
    
                var data = $('#{$id} form').serialize();
               
                $.ajax({
                    url: '{$action}' || location.href,
                    data: data,
                    type: 'POST',
                    dataType: 'html',
                    success: function (data) {
                        setTimeout(function(){
                            lightyear.loading('hide');
                        },500);
                        if(/^\{.+\}$/.test(data))
                        {
                            data = JSON.parse(data);
                            if (data.status || data.code) {
                                
                                if(data.layer_close)
                                {
                                    closeLayer(data.msg || data.message ||'操作成功！');
                                }
                                else if(data.layer_close_refresh)
                                {
                                    closeLayerRefresh(data.msg || data.message ||'操作成功！');
                                }
                                else if(data.url)
                                {
                                    lightyear.notify(data.msg || data.message ||'操作成功！', 'success');
                                    
                                    setTimeout(function(){
                                        location.replace(data.url);

                                    }, data.wait *1000 || 2000);
                                }
                                else
                                {
                                    lightyear.notify(data.msg || data.message ||'操作成功！', 'success');
                                }
                            } else {
                                lightyear.notify(data.msg || data.message || '操作失败', 'warning');
                            }
                        }
                        else
                        {
                            $('#' + search).replaceWith(data);
                        }
                    },
                    error: function () {
                        lightyear.loading('hide');
                        lightyear.notify('网络错误', 'danger');
                    }
                });
    
                return false;
            }
    
            return true;
        }

        function closeLayer(msg)
        {
            parent.lightyear.notify(msg, 'success');

            if(parent && parent.layer)
            {
                var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
                parent.layer.close(index);
            }
        }

        function closeLayerRefresh(msg)
        {
            parent.lightyear.notify(msg, 'success');

            if(parent && parent.layer)
            {
                if(parent.$('#form-refresh').size())
                {
                    parent.$('#form-refresh').trigger('click');
                }
                else
                {
                    setTimeout(function(){
                        parent.location.reload();
                    },2000);
                }

                var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
                parent.layer.close(index);     
            }
        }
    
    </script>
</div>
